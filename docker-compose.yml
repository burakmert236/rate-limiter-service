version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports: 
      - "6379:6379"
    command: redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - ratelimiter-network
  
  rate-limiter:
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: ratelimiter-service
    ports: 
      - "50051-50051"
    environment:
      # Redis connection
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      - REDIS_POOL_SIZE=20
      
      # Server configuration
      - SERVER_PORT=50051
      - LOG_LEVEL=debug
      
      # Optional: Additional settings
      - REDIS_MAX_RETRIES=3
      - REDIS_DIAL_TIMEOUT=5s
      - REDIS_READ_TIMEOUT=3s
      - REDIS_WRITE_TIMEOUT=3s
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ratelimiter-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

networks:
  ratelimiter-network:
    driver: bridge

volumes: 
  redis_data:
    driver: local